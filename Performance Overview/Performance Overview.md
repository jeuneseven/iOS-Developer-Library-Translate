[Performance Overview 原文链接](https://developer.apple.com/library/content/documentation/Performance/Conceptual/PerformanceOverview/Introduction/Introduction.html#//apple_ref/doc/uid/TP40001410)  

# 介绍
性能在所有软件产品中都是一个非常重要的设计因素。如果程序运行缓慢或者始终在加载的话，用户可能会对该程序感到沮丧，并寻找替代方案。维持一个合理的性能水平需要你的付出，但你越早开始考虑，就越容易捕获和修复问题。  

## 谁应该阅读本文档
对于软件性能分析领域的开发新手来说，本文档是一个基本指南。本文档对于管理性能提供了一个概览，并对于定位和修复常见性能问题提供了若干方法。它还为你介绍了一些特定的工具以及你可以用来定位和修复性能问题的相关文档。

## 本文档的组织结构
本文档有以下章节：  

* 为性能而开发：描述了构成性能的相关因素以及如何在你的软件当中达到最佳性能的方法。
* 基本性能提示：描述了分析你的代码的常见区域，并提供了一些基本性能技术。
* 性能工具：描述了可以用来对你的程序进行性能分析的可用工具。
* 进行初始性能评估：带你了解一些关键工具的基本介绍并向你展示了如何使用它们来查找性能问题。

## 提供反馈
若你对于文档有反馈，你可以使用每个页面底部内置的反馈表格来提交。  
若你在Apple软件或文档中遇到了bug，我们推荐你将其报告给Apple。你也可以提交更详细的文件来描述你想在未来的产品或文档中想要看到的功能。若要提交bug或者详细请求的文件，请至bug报告页面：[Apple Developer website](http://developer.apple.com/bugreporter/)  
要提交bug，你必须注册为Apple开发者。你会在以下页面中免费获得一个登录名：[Apple Developer Registration page](http://developer.apple.com/programs/start/register/create.php)

## 另请参阅
除了本文档，还有一些文档覆盖了性能的各个方面。你可以查阅这些文档的详情来了解如何分析和解决性能问题。  

* Code Size性能指南：对于如何提高你的程序的内存蓝图提供了一些建议。
* Code Speed性能指南：对于如何调试你的算法以及查找性能瓶颈提供了一些建议。
* 绘制性能指南：对于如何优化你的程序的绘制相关的代码提供了一些建议。
* 文件系统性能指南：对于如何更高效的访问文件提供了一些建议。
* 启动时间性能指南：对于如何提高你的应用程序的启动时间提供了一些建议。
* 内存使用性能指南：对于如何高效使用内存以及如何分析你当前的内存使用提供了一些建议。
* 并发编程指南：对于如何并行执行任务提供了详细信息和示例。
* 64位迁移指南：讨论了64位二进制的性能影响以及提供了何时该适当的创建相应的二进制提供了指南。

# 为性能而开发
性能是软件设计的一个经常被忽视的方面，直到它变成很严重的问题时才被重视。如果你在开发周期快要结束时才开始进行性能调试的话，就很可能做不到任何有意义的调试了。性能是在早期设计阶段当中就应当被包含进去的，并且在整个开发周期当中是贯穿的。  
当然，为了能够设计好性能，有助于了解什么是性能。本章提供了一些影响性能的因素的背景信息，这些因素是如何在OSX和iOS当中展示的，以及你要怎样监控这些因素。
## 什么是性能？
名词“性能”对于不同的人来讲可能意义不同。所以在着手探索提高你的应用程序的性能之前，现在是了解这一词汇意义的好时机。  
很多人都将性能等同于速度。确实，如果一个程序在一秒内就执行了一个复杂的操作，你可能觉得该程序的性能不错。不过，从本身来看，速度可能是一个误导性的衡量标准。在复杂的软件系统当中，一个操作的速度并不是一个固定值。如果你在不同的条件下执行同样的操作几次的话，该操作完成所需要花费的事件可能大不相同。这是因为程序仅仅是本地系统当中诸多进程共享资源之一而已，而使用（或者说是滥用）这些资源是会影响所有其他进程的。  
以下章节从两个概念解释了性能：高效的资源利用和性能的感知。两个概念都会对于你在设计和实现你的应用程序时有重要影响，你需要理解如何使用这两方面来提高整体性能。  
### 高效的利用资源
CPU共享了一部分资源给所有的正在运行的进程。在最底层，这些资源分为以下几类：  

* CPU时间
* 内存空间
* 块存储空间

你的所有数据要么存在在内存中，要么以某种形式存在在块存储设备中，并且是必须能够被CPU所操作的。一个高效的应用程序会谨慎的使用这些资源。以下段落提供了每种类型的资源的详情以及它是如何影响你的应用程序的。  
#### CPU时间
CPU时间由系统分配，因此你必须充分利用所有的时间。由于OSX和iOS都实现了对称多进程，系统的每个线程都被赋予了一个小的切片时间（最大10毫秒）来运行。在该时间结束时（或在很多种情况之前）系统会收回CPU的控制权并将时间给予其他线程。  
在一个比较典型的拥有多个活动线程的系统当中，如果每个线程都充分利用被分配的时间的话，性能就会很糟糕了。这就引出了一个最重要的编写应用程序的目标：  

目标：如果你的程序无事可做的话，不要消耗CPU时间。  

最好的能够达到这一目标的方法是使用基于事件的模型。使用现代的事件处理系统，比如在Cocoa和iOS中的系统，意味着你的程序的线程只会在工作所需要时才被运行。  
当你应用程序确实有任务要做时，应当尽可能高效的利用CPU时间。这就意味着你需要为你期待处理的数据量选择合适的算法。这也意味着使用其他的系统资源，比如可用的矢量单元（OSX中的AltiVec或者SSE）或者图形处理来执行特定的操作，这就引出了以下目标：  

目标：尽可能的将工作移出CPU。  

关于一些如何高效的使用CPU时间的基本信息，参见“优化基本原则提示”部分。对于特定的与提高绘制操作速度相关的内容，参见“绘制代码”部分。
#### 内存空间
现代计算机硬件上的内存通常由逐渐变慢（但较大）的内存类型组成。最快速的可用内存会给CPU的寄存器来使用。次快速的是L1缓存，紧接着是L2和L3缓存（如果有的话）。再接下来的最快速的内存是主要的内存。由虚拟内存页组成的最慢的内存部分位于OSX的磁盘上，并且在使用前必须进行分页处理。  
在理想情况下，每个应用程序都应该足够小来塞进系统最快的缓存内存中。不幸的是，大部分的应用程序的代码和数据都存在于主内存或者硬盘上。所以，重要的是应用程序的代码和数据的组织方式应该最大限度的减少这些在速度较慢的媒体上花费的时间，这就引出了以下目标：  

目标：减少程序的内存占用。  

减少你的程序的内存占用可以显著的提高性能。很小的内存占用通常有两个优势，第一，你的程序越小，它所占用的内存页就越少。更少的内存页数通常意味着更少的分页。第二，更少的代码量意味着更容易优化和组织。因此，执行一个任务所需的较少的指令和代码都被集中到同一个内存页集合中。  
为了能够降低你的应用程序的内存占用，你应当在你的应用程序中尝试降低可写内存页的占用。可写的内存页为你的应用程序存储了全局或分配数据。在OSX中，如果需要的话，内存页是可以被写入到磁盘中的，但这么做会很慢。在iOS中，这些内存页的内容比如由应用程序本身手动清理，这就可能需要应用程序随后重新创建这些页面的数据。不论哪种情况，系统释放的内存的工作都需要时间——执行你的程序的代码可以更好的花费时间。  
关于如何降低你的程序的内存占用的基本信息，参见“应用程序占用”。关于特定的如何更高效使用内存的相关建议，参见“内存分配代码”。
#### 块存储空间
文件系统的性能在任何计算机上都是非常重要的，因为几乎所有的内容都存在于文件的某个位置中。你的应用程序，数据和操作系统本身都存在于文件当中，并且必须从设备上被加载到内存中，并且与系统的其他部分相比，这非常慢。文件系统，无论是本地或者基于网络的，都是一个性能的最大瓶颈。这也引出了另一个目标：  

目标：消除不必要的文件操作并根据实际需要延迟其他的信息。  

移除了这一瓶颈，通过消除或推迟文件操作，这对于提高整体应用程序的性能很重要。从你向一个文件请求数据到你的程序真正收到数据这一过程中会有数百万的CPU循环经过。若你的程序访问了大量的文件，那么在接收到所有数据之前，可能需要等待很多秒。  
另一个需要记住的比较重要的事是你的应用程序和它所创建的任何文件都可能位于网络上而不是本地硬盘上。尤其是在OSX上，尽可能的让网络不可见，这样你永远不应该对文件的位置进行假设。  
关于如何提高你的程序的基于文件的性能的相关信息，参见“文件访问代码”。
### 速度的感知
即使你是为了优化性能调试你的应用程序，但是整体上你的应用程序也是有可能很慢的才展示给用户。问题是无法避免的：如果你有很多工作要做，你需要CPU时间和各种资源来做那些工作。对于你的应用程序的速度上的展示你也有很多事情要做，这就引出了以下目标：  

目标：让你的应用程序及时反馈给用户。  

对用户来说，响应速度通常是比原始速度更重要的因素。只要程序及时的响应命令，用户通常会愿意接受一些任务是需要花费比较久的时间来执行的。你可以通过让程序在后台处理数据来达到让用户继续操作并感知到速度的目的。通过提升并发执行任务的数量来让你的应用程序更好的反馈用户是一个比较好的方式。并发功能通常使用GCD或多线程来实现。当你的应用程序在主线程反馈用户时，调度队列或后台线程可以执行计算或其他的耗时操作。  
其他的常见的让你的应用程序展示更快的方式是提高启动速度。一款应用程序如果花费超过一到两秒才加载出来的话就有点太久了。不只是在这个期间无法给用户以反馈，并且加载的资源可能不是需要的或者根本用不到，这就是浪费。  
有关如何提高启动时间的相关信息，参见“启动时间初始化代码”部分。有关提高应用程序感知性能的相关信息，参见“利用感知性能”部分。  
## 跟踪性能
唯一能够确保高性能的方式是将性能指标纳入你的产品设计当中，并且根据这些指标对你的产品进行测试，并贯穿整个开发过程。高性能不是一个你能够在开发末期才引入到你的代码的一个功能；它是与开发循环紧密相关的。当代码编写后，知晓它对于你的程序整体性能的影响是很重要的。如果你较早的检测到了性能问题，你就可以在不算晚的时候修复它们。  
判断你是达到还是超过了一个特定指标的方式是收集数据。Apple为你提供了几个工具来检测和分析一个程序的性能。你也可以直接将测试工具构建到你的代码中来帮助自动的处理收集数据。不论你选择哪种方案，你都需要经常定期的练习这些工具并分析结果。
### 创建你的基本度量标准
首先你需要做的事情是决定一系列的你想要测量的基本度量标准。选择你认为对于用户最重要的任务并为这些执行的任务确定一系列的约束。举例来说，你可能希望你的应用程序加载和展示其初始化的窗口少于1秒，或者你可能想要让你的整体内存使用维持在一个给定的目标范围内。  
你所选择的需要测量的任务应该反应你的用户的需要。你们的营销部门应该能够帮助你选择一系列的用户需要的任务。如果你已经有了确定的产品，应该与你的用户交流找出他们觉得比较慢的功能并将提高这些功能的性能作为你未来更新版本的一部分。  
一旦你有了一系列你想要跟踪的任务，你就需要为每个任务决定性能目标。对于已经发布的产品，你可能需要做的就是要相比之前的版本提高性能即可。你可能也要试图衡量的竞争对手的产品的性能以及设置接近或超过它们的性能目标。如果你是在做一个新产品，你可能就需要体验几次来找出一些比较可靠的值了。或者，你可能会定一些比较好的基准线值，并尽量向其靠近。  
无论是任何性能测量，一致性是很重要的。你在确立基准线的过程中，应该包含你所收集的这些数据的系统相关的信息。记录系统的硬件和软件配置的详细信息，并应当在测试时也使用同样的配置。尽量使用最慢的硬件配置来确定你的基准。测量一个比较快的机器上的产品的数据可能会让你误以为你的软件执行的不错，但很多用户可能运行软件的时候是比较慢的处理器和比较低的内存。
### 尽早测量，经常测量
性能数据不是那种你可以在你的程序中收集一次就期望能找到所有性能瓶颈的数据。如果你保留你的程序性能的历史收集记录的话，就比较容易找到问题了。维护一个历史收集记录的话，会比较容易看出你的应用程序的性能是在提升还是在下降。如果是在下降，你就可以在发布产品之前采取措施来修正问题。  
定期测量性能的另一个原因是你可以将结果与代码签入关联起来。如果在一个特定版本中性能有所下降，你就可以review在该版本之前的代码并找到为什么。同样的，如果性能提升了，你就可以使用近期所更改的代码作为好的代码范例模板推荐给你的team来使用相同的技术。  
一旦有了部分功能的程序，就应该立即开始进行性能测量。一旦一个功能添加，你就可以为这些功能添加测量了。将一组自动诊断程序直接添加到你的程序中，就能够容易让你的团队的成员更快更简单的看到结果。如果这些信息随时可用，那么他们就可以更轻松的在签入代码前修复性能问题。  
### 分析你的结果
收集数据在定位性能瓶颈当中是最重要的一步。不过一旦你有了数据，通过使用数据来找到问题也是很重要的。分析性能数据不像直接看输出就能看出问题那么简单。你可能走运直接看出问题，但是很多问题都是很狡猾并需要更加仔细的分析的。  
一种能够帮助分析结果的方式是将结果形象的展示出来。可视化的性能数据能够帮助你比数据表格或者其他的基于文字的媒介更快的看出数据的趋势。举例来说，你可以图形化的对比完成一个操作和一个特定的构建的时间花费来判断性能是在提升还是下降。图形化的展示多种数据集合对比相同集合的里程碑也能够揭示一些趋势并能够对性能为什么提升或下降提供了一些观察角度。  
#### 分析更高水平的算法
当你开始分析性能数据时，对于问题所在的抽象级别持开放心态。假设你拥有的数据表明在特定的函数中花费了大量的时间。那么该函数本身的代码可能就需要优化的执行更快一些了，但这是引起问题的原因么？再次运行你的程序，但这次检查一下该函数执行的次数。如果函数被调用了上百万次，那么问题可能就存在于上层算法调用的地方了。如果函数只被调用了一次，那么函数体可能就是问题所在。  

```
注意：Instruments对于分析你的程序的运行时行为是一个强有力的工具。Instruments能够让你记录多种数据，并且能够一个接一个的展示它们，这能够更直观的看出趋势。Instruments的数据采集能力是另一个从高层算法定位问题的非常好的方式。更多的关于Instruments的相关信息以及Apple提供的工具，参见“性能工具”部分。  
```

性能工具本身是有局限性的，在分析数据的时候你需要理解并考虑它。举例来说，示例程序可能会指出你的应用程序耗时很多的地方，但你应该理解这些工具在得出这些结论之前是如何收集数据的。示例工具不会跟踪每个函数的调用。反之，它们会基于一个固定的间隔来提供一个你的程序的静态分析。要使用这些工具的输出作为指引，但也要确定这些数据与你收集的其他数据有所关联。
#### 其他分析技术
如果你怀疑引起性能问题的原因的真实性，请避免对问题的原因进行假设。相反，请通过将数据收集工作的重点放在相关代码上来优化分析。尝试使用不同的工具来收集新类型的信息。不同的工具可能会提供一个独特的视角来揭示更多真实的问题。  
一些你能够用来分析程序的其他方式包含以下几种：  

* 查看debugger调试器中的代码。便览在调试器中的代码可能能够揭露导致代码运行缓慢的逻辑错误。
* 为代码添加监测点来输出代码被执行时的日志信息。有关使用监测点来跟踪初始化代码的例子，参见“启动时间性能指南”一文。
* 尝试编写一种问题的替代方案，看在其运行时是否有类似的问题。

# 基本性能建议
本章提供了一些比较实际的建议来让你调试你的程序。还提供了一些你应该使用性能工具监控的部分以及提供了一系列实际的提示来提高性能。
## 常见需要监控的地方
很多性能问题能够通过跟踪你的程序的特定部分来定位。当你在设计编码时，你应该监控这些区域来确保它们达到你所设定的性能目标。
### 为你的程序的关键任务进行编码
在你设计你的程序时，你要考虑用户要遇到的最多的任务或工作流。在你实现的过程中，要确保这些任务的代码能够监控并且性能不能够让其性能低到无法接受的水平。一旦性能降低，你应该立即采取措施修正问题。  
每个程序所执行的关键任务是不同的。举例来说，一个文字处理程序可能需要尽快处理文字输入和展示，而一个文件工具程序可能就需要尽快扫描文件并找到一个磁盘上的路径。是由你来判断你的用户最常用的功能的。  
更多的关于如何判断以及修复你的程序的慢操作的相关信息，参见“程序速度性能指南”一文。
### 绘制代码
大部分程序都会做一些绘制相关的内容。如果你的程序只用了标准的窗口和控件的话，那么你就不需要担心绘制性能了。不过，如果你做了一些自定义绘制的事，你就需要监控你的绘制代码并确保它的执行能达到一个可接受的水平。特别是，如果你支持了以下功能，你就应该研究优化绘图相关的代码的方法了。  

* 实时调整大小
* 自定义视图绘制代码，尤其是视图的部分可以被更新而无需更新整个视图的情况
* 文字绘制
* 整体不透明视图

更多关于如何优化绘制性能的相关信息，参见“绘制性能指南”一文。
### 启动时间初始化代码
启动时间是指你初始化你的程序数据结构并让你的应用程序准备好接收用户输入的时间。不过，很多程序都在启动的时候做了很多不必要的工作。大部分情况下，需要在启动时执行的任务都可以推迟到用户界面已经展示出来并且开始处理事件的时候做。这种推迟会让用户觉得你的应用程序启动很快，这会给用户留下很好的第一印象。  
对于需要运行在OSX10.3.3以及更早版本的应用程序而言，另一个可以提升启动时间的方法是预绑定你的应用程序。预绑定包含预计算库地址范围以及存储这些值到你的应用程序的二进制当中。这一步将启动时动态加载所需计算的时间消除了。改进 OSX 10.3.4版本以及之后的版本的dyld使得预绑定没有什么必要了。同样的，预绑定在iOS上也是不必要的。  
更多关于如何提升启动时间性能的相关信息，参见“启动时间性能指南”一文。
### 文件访问代码
从文件系统读取信息到内存或CPU是一个瓶颈。在访问一个文件的时间当中，数以百万的指令可能被执行。所以有必要检查你的程序在使用文件时是否是确实需要的以及使用的是否合适。  
尽量减少使用的文件的数量是一种提升文件相关性能的方式。当你访问一个文件时，要记住以下几点：  

* 要理解文件系统是如何缓存文件数据的，并要知晓如何优化这些缓存的使用。要避免自己来缓存数据，除非你打算引用它超过一次。
* 无论何时都要按照顺序读写数据。跳过一个文件会花费额外的事件来寻找新的位置。
* 尽可能从文件读取大块的数据，记住一次读取太多的数据可能引起不同的问题。举例来说，读取一整个32MB的文件可能会在操作完成前触发这些文件的分页。
* 避免不必要的关闭和重新打开文件。如果可以缓存，这么做可能会在数据并没有改变的时候就会引起缓存的刷新。

更多的关于如何定位和修复文件相关的性能问题的信息，参见”文件系统性能指南“一文。
### 应用程序蓝图
你的代码的大小会对于系统的性能有着极大的影响。你的程序使用的内存分页越多，那么留给系统和其他程序的可用内存就越少。内存的压力最终会导致分页和整个系统的拖慢。  
管理你的应用程序的蓝图主要是关于管理你的代码以及数据结构。你需要确保你在内存中的正确位置并确保不会引起内存分页不必要的读写。以下问题会引起比较大的内存问题：  

* 代码页包含无用的代码。编译器通常通过编译模块来组织代码，这并不一直是一种最优化的技术。组织模块是基于哪些代码一起执行会是一个更好的选项来判断的。
* 静态或常量数据存储在可写的内存页中。在分页过程中，这种数据会被写入磁盘中，但这是不必要的。尽量做你能做的，将这些数据移动到不可写的分页，让其尽快净化。
* 程序导出的符号化文件比实际需要的要多。符号化文件会占据空间，并且只在外部代码模块调用你的程序时才需要。尽量移除不应该被外部使用的符号化文件。
* 代码没有被编译器和链接器适当的优化。要确保尝试编译器的优化设置并查看哪种对于你的程序而言是最优的。
* 程序包含了太多的frameworks。只加载你的程序真正需要使用的frameworks。

有关如何查找和修复代码蓝图问题的相关信息，参见“代码大小性能指南”一文。
### 内存分配代码
程序会分配内存用来存储永久或临时的数据结构。每次内存分配都伴随着一定的消耗，在CPU时间和内存消耗上都有。理解你的程序何时分配内存并直到这些内存如何使用的会对于你降低这些消耗有所帮助。  
理解你的程序的内存是如何使用的是一种降低用量的判断方式。你可以使用可用的性能工具来查找是否一个自动释放的OC对象在其引起足够多的内存分页之前就被释放了。你也可以使用这些工具来找出你的代码中引起的内存泄漏。查看你调用malloc的次数可能找出你能够重用已经存在的内存块而非创建一个新的。  
在分配内存时一个重要的规则是要尽量懒加载。尽量将时机推迟到你实际需要内存的时候。一些额外的可以懒加载分配内存的方式参见“要懒”一节。  
有关如何优化你的内存分配模式的相关信息，参见“内存使用性能指南”一文。
## 优化基本原理提示
在你实现一个新程序之前，以下有一些性能增强部分你可以考虑添加。尽管你可能不能够在每个地方利用所有的这些增强部分，你也应该至少在你的设计期间考虑它们。
### 要懒
一个非常简单的提升性能的方式是确保你的应用程序没有执行任何不需要的工作。  
其他的懒加载的内容包含以下几点：  

* 推迟内存分配直到你真正需要内存的时候。
* 不要零初始化内存块。调用calloc函数来代你懒加载。
* 给予系统机会来懒加载你的代码。

### 利用已知的性能数据

### 使用基于事件的处理

### 提高你的程序任务的并发性

### 使用加速framework

### 使你的应用程序更现代化

# 性能工具
我们提供了几个可视化的应用程序和命令行工具来收集性能数据。一些性能工具在Xcode安装的时候就已经一起安装了。其他的工具可以从 [Apple Developer website](http://developer.apple.com/) 下载到。
## 关键应用程序
尽管Xcode提供了很多的应用程序来收集性能数据，但还是有一些你可以用来更频繁的使用的工具。
### Instruments

## 分析工具

## 监控工具

## 硬件分析工具

## 额外的命令行工具

# 开始性能评估

## 使用top

## 使用Instruments

## 使用Quartz来debug