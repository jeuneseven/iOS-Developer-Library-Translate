[Collection View Programming Guide for iOS 原文链接](https://developer.apple.com/library/content/documentation/WindowsViews/Conceptual/CollectionViewPGforIOS/Introduction/Introduction.html#//apple_ref/doc/uid/TP40012334)

# 介绍
## 关于iOS Collection View
collection view是一种使用灵活可变的布局展示一组有序数据元素的方式。通常使用collection view来展示类似网格布局的元素，但iOS中的collection view的能力不仅仅是行和列那么简单。使用collection view 能够通过定义好的子类精确布局可见元素并能够动态改变，所以你可以实现单元格，堆列，环绕布局，动态的改变布局，或任何你能够想象的布局类型。  
collection view将被展示的数据和用来展示数据的可视化元素严格区分开。在大部分情况下，你的应用程序只需要负责管理数据即可。你的应用程序也可以提供视图对象来展示数据。collection view会利用你的视图对象并完成它们在屏幕上布局的所有工作。这个过程会结合布局对象来做，布局对象指定了你的视图的位置和可视化属性，它还可以子类化来适合你的应用程序所需。因此，你负责提供数据，布局对象提供布局相关信息，collection view会将两者结合来完成最终的显示。

### 概览
标准的iOS collection view提供了所有你需要实现简单网格所需的行为。你还可以扩展标准类来支持自定义布局并指定这些布局之间的交互。
#### Collection View管理着数据驱动视图的可视化展示
collection view会协助你的应用程序所提供的数据驱动的视图的显示。collection view只关心如何使用你的视图以及将其以特定方式布局出来。collection view只关心你的视图的展示和排版，而不关心其内容是什么。理解了collection view与其数据源，布局对象以及你的自定义对象之间的交互对于在你的应用程序中灵活高效的使用collection view是很重要的。

```
相关章节：collection view基础，设计你的数据源和代理
```

#### 流式布局支持网格以及其他面向行的展示
流式布局对象是由UIKit提供的混合布局对象。通常使用该对象来实现网格——行列交错的元素——不过流式布局支持任意类型的线性流。由于它不仅仅为网格所设计，你还可以通过使用它或子类化它来创建各种有意思和灵活的排版内容。流式布局支持不同尺寸的元素，不同间距的元素，自定义段头和段尾，并无需子类化即可自定义边距。子类化能够让你更灵活的使用流式布局的各种功能。

```
相关章节：使用流式布局
```
#### 手势能够被用在cell和布局操作上
像所有的视图一样，你可以将手势附加到collection view上来操作该视图的内容。由于collection view包含了一组不同的视图，了解一些结合手势到collection view的基本技术会有所帮助。你可以使用手势来操作布局属性或collection view的单元格。

```
相关章节：接入手势支持
```
#### 自定义布局能够让你不局限于网格
你可以为你的应用程序继承基本的布局对象来实现自定义布局。尽管设计一个自定义布局无需编写大量代码，但如果你能够理解布局是如何工作的，你就能更好更高效的设计你的布局对象。指南的最后一章会集中分析一个示例工程，该工程会实现一整套自定义布局。

```
相关章节：创建自定义布局，自定义布局举例
```
### 预备知识
在阅读本文档之前，你应该对于视图在iOS应用程序中所扮演的角色有一定的理解。如果你是一个iOS开发的新手并对iOS视图结构不太熟悉的话，请先阅读“iOS视图编程指南”。
### 另请参阅
Collection View与table view有一些类似，它们都能够展示有序的数据给用户。table view的实现与一个标准collection view（使用给定流式布局）在使用索引，单元格和视图循环的过程类似。不过table view的展示是沿一个单列布局所展示的，而collection view能够支持多种不同的布局。更多关于table view的相关信息，参见“iOS table view编程指南”。
# Collection View基础
要展示其内容到屏幕上，collection view要与很多不同的对象共同合作。有些对象是自定义的，并必须由你的应用程序所提供。比如，你的应用程序必须提供一个数据源对象来告诉collection view有多少元素需要显示。其他对象由UIKit所提供并且是collection view基础设计的一部分。  
像table view一样，collection view也是数据驱动的对象，它的实现涉及你的应用程序对象的协作。若要理解你的代码需要做什么，你需要了解一些有关一个collection view都做了些什么的背景知识。
## 一个Collection View就是一组合作的对象
collection view的设计是将数据从被安排和展示到屏幕上与将要展示的数据进行分离。尽管你的应用程序需要完全负责管理被展示的数据，但它的可视化部分同样也被很多不同的对象所管理。清单1-1列出了UIKit中的 collection view相关类以及他们在实现一个collection view界面的过程中所扮演的角色。大部分类都被设计为无需通过子类继承即可使用，所以你可以通过使用很少量的代码就能够实现一个collection view。若你需要更多功能，你可以通过子类扩展。  

清单1-1 实现collection view的类和协议  

| 用途  | 类/协议  | 描述 |
|:------------- |:---------------:| -------------:|
| 顶层容器和管理      | UICollectionView UICollectionViewController | UICollectionView类的对象为你的collection view的内容定义了可视化区域。该类由UIScrollView扩展而来，可以根据需要包含一大块可滚动区域。该类同样能够协助从布局对象所接收的布局信息来展示数据。UICollectionViewController类的对象提供了一个collection view的视图控制器级别的支持。它的使用是可选的。 |
| 内容管理      | UICollectionViewDataSource 协议 UICollectionViewDelegate 协议 | 数据源对象是与collection view相关的最重要的对象，也是你必须提供的。数据源管理着collection view的内容，并创建该内容所需要展示的视图。要实现一个数据源对象，你必须创建一个遵循UICollectionViewDataSource协议的对象。collection view的delegate对象能够让你从collection view获取你想要的信息，并定制化视图的行为。比如，你可以使用代理对象来跟踪collection view中的选取和高亮元素。和数据源对象不同，代理对象是可选的。关于如何实现数据源和代理对象的相关信息，参见“设计你的数据源和代理”部分。 |
| 展示      | UICollectionReusableView UICollectionViewCell | 所有在collection view中展示的视图必须是UICollectionReusableView类的实例对象。该类支持一种collection view使用的循环机制。循环视图（而不是创建新视图）通常会提高性能，尤其是在其滚动的时候。UICollectionViewCell对象是一种你主要用来展示数据元素的特殊类型的重用视图。 |
|  布局   | UICollectionViewLayout UICollectionViewLayoutAttributes UICollectionViewUpdateItem | UICollectionViewLayout的子类被称为布局对象，它负责定义单元格的位置，尺寸以及可视化的属性，并在一个collection view中重用视图。在布局期间，一个布局对象会创建属性对象（UICollectionViewLayoutAttributes类的实例对象）来告诉collection view在哪以及如何展示单元格和重用视图。布局对象会在有数据元素插入，删除或移动到collection view时接收到UICollectionViewUpdateItem类的实例发出的消息。你无须自己创建该类的实例对象。有关更多关于布局对象的相关信息，参见“布局对象控制了界面展示” |
|  流式布局   | UICollectionViewFlowLayout UICollectionViewDelegateFlowLayout | UICollectionViewFlowLayout类是你用来实现网格或其他基于行式布局的混合布局对象。你可以使用该类本身或结合流式代理对象一起使用，后者能够让动态的你定制化布局信息。 |

图1-1展示了一个collection view的核心对象之间的关系。collection view会从它的数据源获取有关展示单元格的相关信息。数据源和代理对象是由你的应用程序提供的自定义对象，它们用来管理内容，包括单元格的选中和高亮。布局对象负责决定这些单元格在什么位置显示以及将这些信息以一个或多个布局属性对象的形式发送给collection view。collection view随后会合并布局信息与实际的单元格（以及其他视图）来创建最终的展示式样。  

图1-1 合并内容和布局来创建最终的展示  
![](https://developer.apple.com/library/archive/documentation/WindowsViews/Conceptual/CollectionViewPGforIOS/Art/cv_objects_2x.png)

当创建一个collection view界面的时候，首先你可以将一个UICollectionView对象添加到你的故事版或nib文件当中。将collection view看做一个中央集线器，所有的其他对象都从中发出。在添加完该对象之后，你可以开始配置其他相关对象，比如数据源或代理。所有的配置都是围绕着collection view本身的。比如，你在已经创建了一个collection view对象之后就无需创建一个布局对象了。
## 重用视图能够提高性能
Collection View使用了一种视图循环程序来提高性能。当视图移出屏幕的时候，它们将会被从视图移除并被放置到一个重用队列当中（而非被删除）。当新的内容滚动到屏幕上时，被从队列中移除的视图会被重新复用给新的内容。为更好的使用这种循环和重用，所有的被collection view所用来展示的视图都必须从UICollectionReusableView类所扩展。  
Collection View支持三种不同类型的重用视图，每种都有特定用途：  

* Cells（单元格）展示了你的collection view的主要内容。一个单元格的工作就是负责从你的数据源对象展示一个单一的元素。每个单元格都必须是UICollectionViewCell类的实例，当然你可以根据需要继承来展示你的内容。单元格对象内置提供了管理它们本身被选中和高亮状态的支持。要想将一个高亮效果添加到一个单元格上，你必须自己编写代码。更多关于实现单元格高亮/选中的相关信息，参见“管理选中和高亮状态”。
* Supplementary views（辅助视图）负责展示关于一个段落的相关信息。像单元格一样，辅助视图也是数据驱动的。不过，辅助视图不像单元格一样被强制实现，它们的使用和放置的位置被布局对象所控制。比如，流式布局支持段头和段尾作为辅助视图的可选项。
* Decoration views（装饰视图）是被布局对象所管理的装饰效果，它不受限于你的数据源对象。举例来说，布局对象通常使用装饰视图来实现一个自定义背景展示。

与table view不同，collection view不会给单元格强加任何特定样式，而辅助视图完全由你的数据源所提供。基本的重用视图类就像空白画板一样供你修改。比如，你可以使用它们来构建小的视图层级，展示图片，甚至可以动态的绘制内容。  
你的数据源对象负责提供与collection view相关的单元格和辅助视图。不过，数据源不需要直接创建视图，当有视图请求的时候，你的数据源需要使用collection view提供的方法从视图队列中提供需要的视图类型即可。无论是从重用队列中检索还是使用一个你提供的类，nib文件或故事版来创建一个视图，出列的过程应当始终返回一个合法的视图。  
更多关于如何从你的数据源创建和配置视图的相关信息，参见“配置单元格和辅助视图”。
## 布局对象控制了界面展示
布局对象只负责决定collection view中的元素位置和样式。即使你的数据源对象提供了视图和实际内容，但它的大小、位置以及其他可见的属性都是由布局对象所决定的。这种分开负责的方式能够让你动态的改变布局，而无需改变任何你的应用程序所管理的数据对象。  
collection view所使用的布局过程与应用程序视图的其余部分的使用相关，但有别于它。换句话说，不要混淆布局对象所做的与在父视图内重新定位子视图的layoutSubviews方法所做的。布局对象不会直接接触它所管理的视图，因为它实际上并不拥有任何视图。它会直接生成collection view中描述单元格，辅助视图和装饰视图的位置，尺寸和可视化的相关属性。随后collection view会将这些属性应用到实际的视图对象上。  
布局对象如何作用于一个collection view中的视图是没有限制的。布局对象可以移动一些视图中的一部分而其他部分不动。它还可以只移动视图一点点，或让它们沿屏幕随机移动。它甚至可以不用管周边的视图，只重新布局当中的视图。举例来说，布局对象能够让任意视图放置到视图栈的顶部。唯一真正的限制是布局对象如何影响你希望应用程序拥有的视觉样式。  
图1-2展示了一个垂直滚动的流式布局是如何对其单元格和辅助视图进行排版的。在垂直滚动流式布局中，内容区域的宽度保持固定，高度随内容增大。为了估算区域，布局对象会一次将视图和单元格进行布局，为它们选择最合适的位置。在流式布局这种情况下，单元格和辅助视图的尺寸会被指定为属性，无论是通过布局对象还是使用代理。计算布局就是使用这些属性将每个视图放置的问题。  

图1-2 布局对象提供了布局相关的度量  
![](https://developer.apple.com/library/archive/documentation/WindowsViews/Conceptual/CollectionViewPGforIOS/Art/cv_layout_basics_2x.png)

布局对象不止控制了视图的尺寸和位置。它还指定了其他视图相关的属性，比如透明度，在3D空间中的转换以及相对于其他视图之上或之下的可见性（如果有的话）。这些属性能够让你创建更多有趣的布局。比如，你可以通过将视图放在彼此的顶部并更改其Z轴的顺序来创建单元格堆栈，或者可以在任意轴向上使用转换来对他们进行旋转。  
更多关于布局对象是如何承担collection view的布局的相关信息，参见“创建自定义布局”。
## Collection View自动初始化了动画
Collection View底层内建了动画的支持。当你插入（或删除）元素或段落的时候，collection view会自动的通过动画来展示改变的视图。比如，当你插入一个元素的时候，元素会在插入点之后为新的元素腾出空间。collection view能够构建动画是因为它能够监听元素当前的位置以及计算在插入后的最终位置。因此，它能够动画的展示每个元素从最初位置到最终位置。  
除了动画的展示插入，删除和移动操作外，你还能在任意时刻禁用布局并强制重新计算其布局属性。禁用布局不会直接动画展示元素；当你禁用布局的时候，collection view会以非动画的方式展示它新计算好的位置的元素。而在自定义布局中，你可以使用此行为定期为单元格调整位置，并创建动画效果。
# 设计你的数据源和代理
每个collection view都要有一个数据源对象。数据源对象是你的应用程序所展示的内容。它可以是一个从你的应用程序数据模型中取到的对象，也可以是管理collection view的视图控制器。对于数据源的唯一要求是必须提供collection view所需的相关信息，比如有多少个元素需要显示以及当显示这些视图的时候应当使用哪个视图。  
代理对象是可选的（但推荐使用）对象，它管理着与内容的呈现和交互相关的各个方面。尽管代理的主要任务是管理单元格的高亮和选中，它也可以被扩展为提供额外的信息。比如，流式布局扩展了基本的代理行为来为布局进行定制化，比如单元格的尺寸和它们之间的距离。
## 数据源管理着你的内容
数据源对象是你在使用collection view来展示内容时管理内容的对象。数据源对象必须遵循UICollectionViewDataSource协议，协议定义了你必须支持的基本行为和方法。数据源的任务就是提供给collection view以下问题的答案：  

* collection view要包含多少个段落？
* 对于一个给定的段落，这个段落要包含多少个元素？
* 对于一个给定的段落或元素，当展示相关内容时，应当使用哪个视图？

段落和元素是collection view内容组成的基本元素。一个collection view通常至少含有一个段落并很可能包含更多。每个段落依次包含零个或多个元素。元素代表着你要展示的主要内容，而段落将这些元素组织为逻辑上的一组。举例来说，一款照片类应用程序可能使用段落来代表一个单独的相片集合或在同一天中所拍摄的照片集合。  
collection view查找它所包含的数据时使用NSIndexPath对象。当试图定位一个元素的时候，collection view会使用布局对象提供的索引路径信息提供。对于元素而言，索引路径包含段落号和元素号。对于辅助视图和装饰视图，索引路径包含布局对象所提供的所有信息。辅助视图和装饰视图上的索引路径的意义取决于你的应用程序，尽管第一个索引位置对应数据源当中的特定段落。视图的索引路径更多的是识别性而非表面意义，识别哪个视图是什么类型的是当前需要考虑的。因此举例来说，如果你要使用辅助视图创建段头和段尾，如流式布局中所示，那么索引路径所提供的相关信息就是段落所引用的。  

```
注意：尽管标准的索引路径支持多层级，但collection view的单元格仅支持两层深度的索引路径，即“段落”和“元素”参数，这个与UITableView类的索引路径类似。辅助视图和装饰视图可以根据需要拥有更复杂的索引路径。索引路径大于1的元素被解释为与路径中第一个索引指定的段落相对应。习惯上只需要二级索引，不过辅助视图和装饰视图不受限制。在设计你的数据源时要记住这点。
```

不论你如何排列数据对象的段落和元素，这些段落和元素的视觉效果依旧由布局对象所决定。不同的布局对象能够展示不同的段落和元素数据，如图2-1所示。在该图中，流式布局对象将垂直段落设计为每个连续段落在之前一个段落之后。自定义布局能够将段落排版为非线性布局，布局的显示与实际数据相分离。  

图2-1 段落的排版根据布局对象的布局所排列  
![](https://developer.apple.com/library/archive/documentation/WindowsViews/Conceptual/CollectionViewPGforIOS/Art/cv_layout_sections_2x.png)

### 设计你的数据对象
一个高效的数据源会使用段和元素来帮助组织其基本的数据对象。将你的数据组织成段落和元素将使得实现数据源的方法更为简单。由于数据源的方法经常被调用，你要确保这些方法的实现能够尽可能快的检索数据。  
一种简单的解决方案（当然不是唯一的解决方案）是数据源使用一组嵌套的数组，如图2-2所示。在这种配置下，顶层的数组包含一个或多个代表你的数据源的段落的数组。每个段落的数组又包含该段落的数组元素。在段落中查找元素就变成了查找到该段落的数组然后从该数组查找元素的过程。这种配置能够适当的组织元素的集合以及根据需要检索特定的元素。  

图2-2 使用嵌套数组来管理数据对象  
![](https://developer.apple.com/library/archive/documentation/WindowsViews/Conceptual/CollectionViewPGforIOS/Art/ds_data_object_layout_2x.png)  

当设计你的数据结构的时候，你可以从一个简单的数组集合开始，然后根据需要转换到一个更高效的结构上。一般来讲，你的数据对象应当不应该有性能瓶颈。collection view 访问你的数据源只是为了计算总共有多少个对象，以及为当前屏幕上的元素获取视图。若布局对象只依赖你的数据对象的数据的话，那么当数据源包含上千个对象时，性能将会被严重降低。
### 将你的内容告知collection view

## 配置cell和辅助视图

## 插入，删除和移动段落和单元格

# 使用布局

# 接入手势支持

# 创建自定义布局

# 自定义布局举例